import requests
from fastapi import FastAPI
from datetime import datetime, timezone
from fastapi.middleware.cors import CORSMiddleware
import uvicorn

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- ASETUKSET ---
API_KEY = '75fc91373cc4f2f007c6b356a214a097'
SPORTS = ['upcoming']
REGION = 'eu'

# Vedonlyöntipörssit, joissa käytetään 2% komissiota laskennassa
EXCHANGES = ["Smarkets", "Betfair", "Matchbook", "Betfair Exchange"]

BOOKIE_URLS = {
    # Isot UK-toimijat
    "Bet365": "https://www.bet365.com",
    "Betfair": "https://www.betfair.com/betting/",
    "Paddy Power": "https://www.paddypower.com",
    "William Hill": "https://www.williamhill.com",
    "Unibet": "https://www.unibet.co.uk",
    "Unibet (UK)": "https://www.unibet.co.uk",
    "Ladbrokes": "https://www.ladbrokes.com",
    "Coral": "https://www.coral.co.uk",
    "888sport": "https://www.888sport.com",
    "Sky Bet": "https://www.skybet.com",
    "Betway": "https://www.betway.com",
    "Bet Victor": "https://www.betvictor.com",
    "Smarkets": "https://smarkets.com",
    "Matchbook": "https://www.matchbook.com",
    "Virgin Bet": "https://www.virginbet.com",
    "LeoVegas": "https://www.leovegas.com",
    "Casumo": "https://www.casumo.com",
    "BoyleSports": "https://www.boylesports.com",
    "Betfred": "https://www.betfred.com",
    "NetBet": "https://www.netbet.co.uk",
    "QuinnBet": "https://www.quinnbet.com",
    "LiveScore Bet": "https://www.livescorebet.com",
    "Spreadex": "https://www.spreadex.com",
    "Sporting Index": "https://www.sportingindex.com",
    "Marathon Bet": "https://www.marathonbet.co.uk",
    "Betting.bet": "https://betting.bet",
    "Kwiff": "https://www.kwiff.com",
    "Vbet": "https://www.vbet.co.uk",
    "Grosvenor Sports": "https://www.grosvenorcasinos.com/sport",
    "Mr Green": "https://www.mrgreen.com/en-gb/betting",
    "StarSports": "https://www.starsports.bet",
    "Midnite": "https://www.midnite.com",
    "BetGoodwin": "https://www.betgoodwin.co.uk",

    # Pohjoismaiset ja yleiset EU-toimijat
    "NordicBet": "https://www.nordicbet.com",
    "Betsafe": "https://www.betsafe.com",
    "Betsson": "https://www.betsson.com",
    "Coolbet": "https://www.coolbet.com",
    "Expekt": "https://www.expekt.com",
    "Mr Green (EU)": "https://www.mrgreen.com",
    "Paf": "https://www.paf.com",

    # Keski-Euroopan ja kansainväliset suuret toimijat
    "Bwin": "https://www.bwin.com",
    "Sportingbet": "https://www.sportingbet.com",
    "Betclic": "https://www.betclic.com",
    "Interwetten": "https://www.interwetten.com",
    "Tipico": "https://www.tipico.com",
    "Bet-at-home": "https://www.bet-at-home.com",
    "Winamax": "https://www.winamax.fr",
    "Stoiximan": "https://www.stoiximan.gr",
    "Betano": "https://www.betano.com",

    # Lisää pienempiä/uudempia EU-toimijoita
    "Pinnacle": "https://www.pinnacle.com",
    "Cloudbet": "https://www.cloudbet.com",
    "Stake": "https://stake.com",
    "GGBet": "https://gg.bet",
    "22Bet": "https://22bet.com",
    "1xBet": "https://1xbet.com",
    "Melbet": "https://melbet.com",
    "Rabona": "https://rabona.com",
    "Campobet": "https://campobet.com"
}

@app.get("/get-arbitrage")
def get_arbitrage_data():
    all_arbitrages = []

    for sport_key in SPORTS:
        url = f'https://api.the-odds-api.com/v4/sports/{sport_key}/odds/?apiKey={API_KEY}&regions={REGION}&markets=h2h&includeLinks=true'

        try:
            response = requests.get(url)
            if response.status_code != 200:
                continue

            matches = response.json()

            for match in matches:
                # 1. LIVE-TILAN JA AJAN TARKISTUS
                commence_time_raw = match.get('commence_time')
                is_live = False
                if commence_time_raw:
                    start_dt = datetime.fromisoformat(commence_time_raw.replace('Z', '+00:00'))
                    if datetime.now(timezone.utc) > start_dt:
                        is_live = True

                outcomes_data = {}
                for bookmaker in match.get('bookmakers', []):
                    bookie_name = bookmaker['title']
                    for market in bookmaker.get('markets', []):
                        if market['key'] == 'h2h':
                            for outcome in market['outcomes']:
                                name = outcome['name']
                                price = outcome['price']
                                link = outcome.get('link')

                                # 2. KOMISSION HUOMIOIMINEN PÖRSSISIVUILLA (Nettokerroin)
                                calculation_price = price
                                if bookie_name in EXCHANGES:
                                    calculation_price = 1 + (price - 1) * 0.98

                                if name not in outcomes_data or calculation_price > outcomes_data[name]['calc_price']:
                                    outcomes_data[name] = {
                                        'price': price, # Alkuperäinen kerroin näytettäväksi
                                        'calc_price': calculation_price, # Kerroin jota käytetään voiton laskemiseen
                                        'bookie': bookie_name,
                                        'link': link
                                    }

                # Lasketaan arbitraasiprosentti nettokertoimilla
                calc_odds_list = [item['calc_price'] for item in outcomes_data.values()]
                if len(calc_odds_list) < 2:
                    continue

                arb_percentage = sum(1 / o for o in calc_odds_list)

                # Hyväksytään vain realistiset arbitraasit (ei selkeitä API-virheitä eli > 25% voittoja)
                if 0.75 < arb_percentage < 1.0:
                    outcomes_list = []
                    for name, data in outcomes_data.items():
                        # LINKKI-LOGIIKKA
                        final_link = data['link'] if data.get('link') else BOOKIE_URLS.get(
                            data['bookie'], f"https://duckduckgo.com/?q={data['bookie']}+betting"
                        )

                        outcomes_list.append({
                            "name": name,
                            "price": data['price'],
                            "bookie": data['bookie'],
                            "link": final_link,
                            "has_commission": data['bookie'] in EXCHANGES
                        })

                    all_arbitrages.append({
                        "id": match['id'],
                        "sport": match['sport_title'],
                        "teams": f"{match['home_team']} vs {match['away_team']}",
                        "profit": round((1 - arb_percentage) * 100, 2),
                        "is_live": is_live,
                        "commence_time": commence_time_raw,
                        "outcomes": outcomes_list
                    })

        except Exception as e:
            print(f"Virhe: {e}")

    return sorted(all_arbitrages, key=lambda x: x['profit'], reverse=True)

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
